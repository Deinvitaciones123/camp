<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Invitaci칩n</title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Hugs+and+Kisses&display=swap');

  /* ===== Estilos base ===== */
  body{
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    min-height: 100svh;
    height: auto;
    overflow: auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: clamp(10px, 3vw, 20px);
    padding: clamp(10px, 3vw, 18px) clamp(10px, 3vw, 18px) calc(12px + env(safe-area-inset-bottom));
    background-size: cover;
  }

  h2{
    font-family: 'Aparajita', serif;
    color:#ad83b6;
    font-size: clamp(24px, 6.5vw, 48px);
    text-shadow: 0 0 5px #ffb3c1, 0 0 10px #ad83b6, 0 0 20px #ad83b6;
    margin: 6px 0 4px;
  }

  /* Marco 4:3 */
  .frame-43{
    position: relative;
    width: min(100%, 720px);
    aspect-ratio: 4 / 3;
    border-radius: clamp(16px, 4vw, 26px);
    border: 5px solid #ad83b6;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(151,134,99,.35), 0 0 20px #ad83b6, 0 0 40px #ffb3c1, 0 0 60px #ad83b6;
  }
  @supports not (aspect-ratio: 4/3){
    .frame-43::before{ content:""; display:block; padding-top:75%; }
  }

  .frame-43 > video,
  .frame-43 > img{
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    border: 0 !important; box-shadow: none !important;
  }
  .frame-43 > img{
    object-fit: contain;
    background: transparent;
  }

  /* Botones base */
  #btnsContainer {
    display:flex;
    flex-direction: column;
    gap: clamp(8px, 2.5vw, 12px);
    width: min(100%, 720px);
    align-items:center;
    justify-content:center;
  }
  #btnsContainer button{
    width: 100%;
    min-width: 160px;
    background: linear-gradient(45deg, #ad83b6 , #ad83b6, #ad83b6 );
    background-size: 400% 400%;
    border: none;
    color: white;
    padding: clamp(10px, 3vw, 14px) clamp(14px, 4vw, 18px);
    font-size: clamp(14px, 20px, 20px);
    font-weight: bold;
    border-radius: clamp(10px, 3vw, 14px);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    animation: gradientBG 5s ease infinite;
    position: relative;
    overflow: hidden;
  }
  #btnsContainer button:hover{
    transform: scale(1.03);
    box-shadow: 0 10px 25px rgba(0,0,0,0.35);
  }

  @media (prefers-reduced-motion: reduce){
    *{ animation: none !important; }
  }

  @keyframes gradientBG {
    0%{background-position:0 50%}
    50%{background-position:100% 50%}
    100%{background-position:0 50%}
  }

  /* Miniaturas */
  #thumbs{
    width: min(100%, 720px);
    display: none;
    grid-template-columns: repeat(auto-fill, minmax(96px, 1fr));
    gap: 8px;
    margin-top: 6px;
  }
  #thumbs .thumb{
    width: 100%;
    aspect-ratio: 1/1;
    border-radius: 10px;
    border: 2px solid #ad83b6;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 12px;
    background:#fff;
    overflow:hidden;
  }
  #thumbs img{
    width:100%;
    height:100%;
    object-fit: cover;
  }

  @media (min-width: 768px){
    #btnsContainer{ flex-direction: row; }
    #btnsContainer button{ width: auto; }
  }
</style>
</head>
<body>
  <h2>춰Gracias por acompa침arnos!</h2>

  <!-- Marco 4:3 -->
  <div id="previewBox" class="frame-43">
    <!-- este video lo usamos para c치mara o para mostrar un video de la galer칤a -->
    <video id="video" autoplay playsinline></video>
    <!-- este img solo para fotos -->
    <img id="preview" />
  </div>

  <!-- Miniaturas -->
  <div id="thumbs"></div>

  <div id="btnsContainer">
    <button id="fotoBtn">Tomar Foto</button>
    <button id="flipBtn">Voltear C치mara</button>
    <button id="galleryBtn">Subir desde galer칤a</button>
  </div>

  <!-- Input oculto (ahora acepta imagen y video, y m칰ltiples) -->
  <input id="picker" type="file" accept="image/*,video/*" multiple style="display:none" />

  <canvas id="canvas" style="display:none;"></canvas>

<script>
  /* =========================
     Variables y estado
  ========================== */
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");
  const preview = document.getElementById("preview");
  const thumbs = document.getElementById("thumbs");
  const btnsContainer = document.getElementById("btnsContainer");
  const picker = document.getElementById("picker");

  let stream;
  let useFront = true;

  // Cola de archivos a subir
  // { filename, mime, data, isVideo }
  let uploadQueue = [];

  // Tu endpoint
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbxDKz3QJ8nVmrgRvwKOE66FOgV5CQoM55ZZHiYuXj3_MdrXtlw7Nk3ygMdFWhmKTotshA/exec";

  /* =========================
     C치mara
  ========================== */
  async function startCamera() {
    // Si hab칤a video de galer칤a, lo limpiamos
    video.removeAttribute("src");
    video.removeAttribute("controls");
    if (typeof video.load === "function") video.load();

    // Detener stream anterior
    if (stream) stream.getTracks().forEach(t => t.stop());

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: useFront ? "user" : "environment" }
      });
    } catch (err) {
      console.error(err);
      alert("No se pudo acceder a la c치mara. Puedes subir desde galer칤a.");
      renderInitialButtons();
      return;
    }

    // limpiar estado
    uploadQueue = [];
    thumbs.style.display = "none";
    thumbs.innerHTML = "";

    // mostrar c치mara
    video.srcObject = stream;
    video.style.display = "block";
    video.controls = false;
    preview.style.display = "none";

    renderInitialButtons();
  }

  function renderInitialButtons(){
    btnsContainer.innerHTML = `
      <button id="fotoBtn">Tomar Foto</button>
      <button id="flipBtn">Voltear C치mara</button>
      <button id="galleryBtn">Subir desde galer칤a</button>
    `;
    document.getElementById("fotoBtn").onclick = takePhoto;
    document.getElementById("flipBtn").onclick = () => { useFront = !useFront; startCamera(); };
    document.getElementById("galleryBtn").onclick = () => {
      // reset para que deje elegir lo mismo
      picker.value = "";
      picker.click();
    };
  }

  function takePhoto() {
    if (!video.videoWidth) {
      alert("Espera un momento a que cargue la c치mara.");
      return;
    }
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    const imgData = canvas.toDataURL("image/png");

    preview.src = imgData;
    preview.style.display = "block";
    video.style.display = "none";

    uploadQueue = [{
      filename: "foto.png",
      mime: "image/png",
      data: imgData,
      isVideo: false
    }];

    renderReviewButtons();
  }

  /* =========================
     Galer칤a (im치genes + videos)
  ========================== */
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("No se pudo leer el archivo"));
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }

  picker.addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;

    // detener c치mara si estaba activa
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }

    try {
      const dataURLs = await Promise.all(files.map(readFileAsDataURL));
      uploadQueue = files.map((f, i) => ({
        filename: f.name || `archivo_${i+1}`,
        mime: f.type || "application/octet-stream",
        data: dataURLs[i],
        isVideo: f.type.startsWith("video/")
      }));

      // mostrar preview del primero
      const first = uploadQueue[0];
      if (first.isVideo) {
        // mostramos en el video
        preview.style.display = "none";
        video.style.display = "block";
        video.srcObject = null;
        video.src = first.data;
        video.controls = true;
        video.loop = true;
        video.play().catch(()=>{});
      } else {
        // es imagen
        video.style.display = "none";
        video.removeAttribute("src");
        if (typeof video.load === "function") video.load();
        preview.src = first.data;
        preview.style.display = "block";
      }

      // miniaturas
      if (uploadQueue.length > 1) {
        thumbs.innerHTML = uploadQueue.map(item => {
          if (item.isVideo) {
            return `<div class="thumb">游꿘 ${item.filename}</div>`;
          } else {
            return `<div class="thumb"><img src="${item.data}" alt=""></div>`;
          }
        }).join("");
        thumbs.style.display = "grid";
      } else {
        thumbs.style.display = "none";
        thumbs.innerHTML = "";
      }

      renderReviewButtons();
    } catch (err) {
      console.error(err);
      alert("Ocurri칩 un error al leer los archivos.");
    } finally {
      e.target.value = "";
    }
  });

  function renderReviewButtons() {
    const count = uploadQueue.length;
    const label = count > 1 ? `Subir ${count} archivo(s)` : 'Subir';
    const retake = 'Cancelar / Volver a c치mara';

    btnsContainer.innerHTML = `
      <button id="uploadBtn">${label}</button>
      <button id="retakeBtn">${retake}</button>
    `;
    document.getElementById("uploadBtn").onclick = uploadSelected;
    document.getElementById("retakeBtn").onclick = () => startCamera();
  }

  /* =========================
     Subida
  ========================== */
  async function postOne(item) {
    const payload = {
      file: item.data,    // base64 dataURL
      name: item.filename,
      type: item.mime,
      isVideo: item.isVideo
    };

    try {
      const res = await fetch(ENDPOINT, {
        method: "POST",
        body: JSON.stringify(payload)
      });
      await res.text();
      return true;
    } catch (err) {
      // fallback
      try {
        await fetch(ENDPOINT, {
          method: "POST",
          mode: "no-cors",
          body: JSON.stringify(payload)
        });
        return true;
      } catch (e2) {
        console.error("Fallo al enviar:", e2);
        return false;
      }
    }
  }

  async function uploadSelected() {
    if (!uploadQueue.length) {
      alert("No hay archivos para subir.");
      return;
    }
    const uploadBtn = document.getElementById("uploadBtn");
    if (uploadBtn) {
      uploadBtn.disabled = true;
      uploadBtn.textContent = "Enviando...";
    }

    const results = await Promise.all(uploadQueue.map(item => postOne(item)));
    const ok = results.filter(Boolean).length;
    const fail = results.length - ok;

    alert(`Listo: ${ok} enviado(s) correctamente${fail ? `, ${fail} fall칩/fallaron` : ""}.`);
    finishScreen();
  }

  function finishScreen() {
    if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
    document.body.innerHTML = `
      <h1 style="
        font-family: 'Aparajita', serif;
        color: #ad83b6; font-size: clamp(28px, 7vw, 50px); text-align: center; margin: 10% 16px 0;
        text-shadow: 0 0 5px #ffb3c1, 0 0 10px #ad83b6 , 0 0 20px #ad83b6;">
        춰Gracias! Tus archivos fueron enviados.
      </h1>
    `;
    document.body.style.backgroundSize = "cover";
    document.body.style.display = "flex";
    document.body.style.justifyContent = "center";
    document.body.style.alignItems = "center";
    document.body.style.flexDirection = "column";
    document.body.style.minHeight = "100vh";
  }

  /* =========================
     Inicio
  ========================== */
  startCamera();
  document.getElementById("fotoBtn")?.addEventListener("click", takePhoto);
  document.getElementById("galleryBtn")?.addEventListener("click", () => {
    picker.value = "";
    picker.click();
  });
</script>
</body>
</html>
