<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Invitaci칩n</title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Hugs+and+Kisses&display=swap');

  /* ===== Estilos base ===== */
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    min-height: 100svh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: clamp(10px, 3vw, 20px);
    padding: 12px 10px calc(12px + env(safe-area-inset-bottom));
    background: #f7f0e6; /* beige claro de fondo */
  }

  h2 {
    font-family: 'Aparajita', serif;
    color: #b58b5d; /* dorado/beige oscuro */
    font-size: clamp(24px, 6vw, 48px);
    text-shadow: 0 0 4px rgba(181,139,93,.25);
    margin: 6px 0 4px;
  }

  /* ===== Marco responsivo vertical ===== */
  .frame-43 {
    position: relative;
    width: min(100vw - 20px, 720px);
    aspect-ratio: 3 / 4; /* m치s vertical */
    border-radius: clamp(16px, 4vw, 26px);
    border: 4px solid #d4b996;
    overflow: hidden;
    margin-inline: auto;
    box-shadow:
      0 8px 24px rgba(90, 70, 42, .25),
      0 0 18px rgba(212,185,150,.25);
    background: #000;
  }

  /* En pantallas grandes (modo horizontal o PC) mantenemos 4:3 */
  @media (min-aspect-ratio: 4/3) {
    .frame-43 {
      aspect-ratio: 4 / 3;
    }
  }

  .frame-43 > video,
  .frame-43 > img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover; /* ocupa todo sin deformarse */
    border: none !important;
    box-shadow: none !important;
  }

  /* ===== Botones ===== */
  #btnsContainer {
    display:flex;
    flex-direction: column;
    gap: clamp(8px, 2.5vw, 12px);
    width: min(100%, 720px);
    align-items:center;
    justify-content:center;
  }

  #btnsContainer button {
    width: 100%;
    min-width: 160px;
    background: linear-gradient(45deg, #d4b996, #b58b5d, #d4b996);
    background-size: 400% 400%;
    border: none;
    color: #fff;
    padding: clamp(10px, 3vw, 14px) clamp(14px, 4vw, 18px);
    font-size: clamp(14px, 20px, 20px);
    font-weight: bold;
    border-radius: clamp(10px, 3vw, 14px);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    animation: gradientBG 5s ease infinite;
    position: relative;
    overflow: hidden;
  }

  #btnsContainer button:hover {
    transform: scale(1.03);
    box-shadow: 0 10px 25px rgba(0,0,0,0.25);
  }

  @keyframes gradientBG {
    0%{background-position:0 50%}
    50%{background-position:100% 50%}
    100%{background-position:0 50%}
  }

  @media (min-width: 768px) {
    #btnsContainer { flex-direction: row; }
    #btnsContainer button { width: auto; }
  }

  /* ===== Miniaturas ===== */
  #thumbs {
    width: min(100%, 720px);
    display: none;
    grid-template-columns: repeat(auto-fill, minmax(96px, 1fr));
    gap: 8px;
    margin-top: 6px;
  }

  #thumbs .thumb {
    width: 100%;
    aspect-ratio: 1/1;
    border-radius: 10px;
    border: 2px solid #d4b996;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 12px;
    background:#fff;
    overflow:hidden;
  }

  #thumbs img {
    width:100%;
    height:100%;
    object-fit: cover;
  }
</style>
</head>
<body>
  <h2>춰Gracias por acompa침arnos!</h2>

  <div id="previewBox" class="frame-43">
    <video id="video" autoplay playsinline></video>
    <img id="preview" />
  </div>

  <div id="thumbs"></div>

  <div id="btnsContainer">
    <button id="fotoBtn">Tomar Foto</button>
    <button id="flipBtn">Voltear C치mara</button>
    <button id="galleryBtn">Subir desde galer칤a</button>
  </div>

  <input id="picker" type="file" accept="image/*,video/*" multiple style="display:none" />
  <canvas id="canvas" style="display:none;"></canvas>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");
  const preview = document.getElementById("preview");
  const thumbs = document.getElementById("thumbs");
  const btnsContainer = document.getElementById("btnsContainer");
  const picker = document.getElementById("picker");

  let stream;
  let useFront = true;
  let uploadQueue = [];

  const ENDPOINT = "https://script.google.com/macros/s/AKfycbxDKz3QJ8nVmrgRvwKOE66FOgV5CQoM55ZZHiYuXj3_MdrXtlw7Nk3ygMdFWhmKTotshA/exec";

  async function startCamera() {
    video.removeAttribute("src");
    video.removeAttribute("controls");
    if (typeof video.load === "function") video.load();

    if (stream) stream.getTracks().forEach(t => t.stop());

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: useFront ? "user" : "environment" }
      });
    } catch (err) {
      console.error(err);
      alert("No se pudo acceder a la c치mara. Puedes subir desde galer칤a.");
      renderInitialButtons();
      return;
    }

    uploadQueue = [];
    thumbs.style.display = "none";
    thumbs.innerHTML = "";

    video.srcObject = stream;
    video.style.display = "block";
    video.controls = false;
    preview.style.display = "none";

    renderInitialButtons();
  }

  function renderInitialButtons(){
    btnsContainer.innerHTML = `
      <button id="fotoBtn">Tomar Foto</button>
      <button id="flipBtn">Voltear C치mara</button>
      <button id="galleryBtn">Subir desde galer칤a</button>
    `;
    document.getElementById("fotoBtn").onclick = takePhoto;
    document.getElementById("flipBtn").onclick = () => { useFront = !useFront; startCamera(); };
    document.getElementById("galleryBtn").onclick = () => {
      picker.value = "";
      picker.click();
    };
  }

  function takePhoto() {
    if (!video.videoWidth) {
      alert("Espera un momento a que cargue la c치mara.");
      return;
    }
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    const imgData = canvas.toDataURL("image/png");

    preview.src = imgData;
    preview.style.display = "block";
    video.style.display = "none";

    uploadQueue = [{
      filename: "foto.png",
      mime: "image/png",
      data: imgData,
      isVideo: false
    }];

    renderReviewButtons();
  }

  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("No se pudo leer el archivo"));
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }

  picker.addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;

    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }

    try {
      const dataURLs = await Promise.all(files.map(readFileAsDataURL));
      uploadQueue = files.map((f, i) => ({
        filename: f.name || `archivo_${i+1}`,
        mime: f.type || "application/octet-stream",
        data: dataURLs[i],
        isVideo: f.type.startsWith("video/")
      }));

      const first = uploadQueue[0];
      if (first.isVideo) {
        preview.style.display = "none";
        video.style.display = "block";
        video.srcObject = null;
        video.src = first.data;
        video.controls = true;
        video.loop = true;
        video.play().catch(()=>{});
      } else {
        video.style.display = "none";
        video.removeAttribute("src");
        if (typeof video.load === "function") video.load();
        preview.src = first.data;
        preview.style.display = "block";
      }

      if (uploadQueue.length > 1) {
        thumbs.innerHTML = uploadQueue.map(item => {
          if (item.isVideo) {
            return `<div class="thumb">游꿘 ${item.filename}</div>`;
          } else {
            return `<div class="thumb"><img src="${item.data}" alt=""></div>`;
          }
        }).join("");
        thumbs.style.display = "grid";
      } else {
        thumbs.style.display = "none";
        thumbs.innerHTML = "";
      }

      renderReviewButtons();
    } catch (err) {
      console.error(err);
      alert("Ocurri칩 un error al leer los archivos.");
    } finally {
      e.target.value = "";
    }
  });

  function renderReviewButtons() {
    const count = uploadQueue.length;
    const label = count > 1 ? `Subir ${count} archivo(s)` : 'Subir';
    const retake = 'Cancelar / Volver a c치mara';

    btnsContainer.innerHTML = `
      <button id="uploadBtn">${label}</button>
      <button id="retakeBtn">${retake}</button>
    `;
    document.getElementById("uploadBtn").onclick = uploadSelected;
    document.getElementById("retakeBtn").onclick = () => startCamera();
  }

  async function postOne(item) {
    const payload = {
      data: item.data,
      image: item.data,
      name: item.filename,
      mime: item.mime,
      isVideo: item.isVideo
    };

    try {
      const res = await fetch(ENDPOINT, {
        method: "POST",
        body: JSON.stringify(payload)
      });
      await res.text();
      return true;
    } catch {
      return false;
    }
  }

  async function uploadSelected() {
    if (!uploadQueue.length) {
      alert("No hay archivos para subir.");
      return;
    }

    const uploadBtn = document.getElementById("uploadBtn");
    if (uploadBtn) {
      uploadBtn.disabled = true;
      uploadBtn.textContent = "Enviando...";
    }

    const results = await Promise.all(uploadQueue.map(item => postOne(item)));
    const ok = results.filter(Boolean).length;
    const fail = results.length - ok;

    alert(`Listo: ${ok} enviado(s) correctamente${fail ? `, ${fail} fall칩/fallaron` : ""}.`);
    finishScreen();
  }

  function finishScreen() {
    if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
    document.body.innerHTML = `
      <h1 style="
        font-family: 'Aparajita', serif;
        color: #b58b5d; 
        font-size: clamp(28px, 7vw, 50px); 
        text-align: center; 
        margin: 10% 16px 0;">
        춰Gracias! Tus archivos fueron enviados.
      </h1>
    `;
    document.body.style.background = "#f7f0e6";
  }

  startCamera();
</script>
</body>
</html>
